import _extends from"@babel/runtime/helpers/extends";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{useEffect,useRef,useState}from"react";import MenuItem from"@scaleflex/ui/core/menu-item";import SaveAs from"@scaleflex/icons/save-as";import Label from"@scaleflex/ui/core/label";import{useStore,useTransformedImgData}from"../../hooks";import getFileFullName from"../../utils/getFileFullName";import getDefaultSaveQuality from"../../utils/getDefaultSaveQuality";import{CLOSING_REASONS,ELLIPSE_CROP,SUPPORTED_IMAGE_TYPES,DEFAULT_SAVE_QUALITY}from"../../utils/constants";import{HIDE_LOADER,SET_FEEDBACK,SHOW_LOADER}from"../../actions";import Modal from"../common/Modal";import Slider from"../common/Slider";import restrictNumber from"../../utils/restrictNumber";import{Resize}from"../tools/Resize";import ButtonWithMenu from"../common/ButtonWithMenu";import{StyledFileExtensionSelect,StyledFileNameInput,StyledQualityWrapper,StyledResizeOnSave}from"./Topbar.styled";var sliderStyle={marginBottom:16},saveButtonWrapperStyle={width:67},saveButtonMenuStyle={marginLeft:12},isFieSaveMounted=!0,SaveButton=function(){var a=useStore(),b=useRef(),c=a.theme,d=a.dispatch,e=a.originalImage,f=a.resize,g=a.isLoadingGlobally,h=a.haveNotSavedChanges,i=a.feedback,j=a.t,k=a.adjustments,l=void 0===k?{}:k,m=l.crop,n=a.config,o=n.onClose,p=n.closeAfterSave,q=n.onBeforeSave,r=n.onSave,s=n.forceToPngInEllipticalCrop,t=n.defaultSavedImageName,u=n.defaultSavedImageType,v=n.defaultSavedImageQuality,w=void 0===v?DEFAULT_SAVE_QUALITY:v,x=n.useCloudimage,y=n.moreSaveOptions,z=useState(!1),A=_slicedToArray(z,2),B=A[0],C=A[1],D=useState({quality:getDefaultSaveQuality(w)}),E=_slicedToArray(D,2),F=E[0],G=E[1],H=useTransformedImgData(),I=["jpeg","jpg","webp"].includes(F.extension),J=0===i.duration,K=function handleSave(){var a=H(F,!1,!0),c=b.current||r,e=c(a.imageData,a.designState),f=function hideLoadingSpinner(){d({type:HIDE_LOADER})};e instanceof Promise?e["finally"](f):f(),b.current=null,p&&o&&o(CLOSING_REASONS.AFTER_SAVE,h)},L=function startSaving(){d({type:SHOW_LOADER}),C(!1),setTimeout(K,3)},M=function validateInfoThenSave(){var a=b.current||r;if("function"!=typeof a)throw new Error("Please provide onSave function handler.");return F.name&&F.extension?void L():void d({type:SET_FEEDBACK,payload:{feedback:{message:j("nameIsRequired")}}})},N=function triggerSaveHandler(){if(x){var a=H(F),c=b.current||r;return void c(a.imageData,a.designState)}return b.current||"function"!=typeof q||!1!==q(F)?void C(!0):void M()},O=function changeSaveFnAndTriggerAnother(a,c){if("function"==typeof a)b.current=a,c();else throw new Error("onSave function callback is required as an argument to the passed function.")},P=function setFileNameAndExtension(){var a=getFileFullName(t||e.name,s&&m.ratio===ELLIPSE_CROP?"png":SUPPORTED_IMAGE_TYPES.includes(null===u||void 0===u?void 0:u.toLowerCase())&&u),b=a.name,c=a.extension;G(_objectSpread(_objectSpread({},F),{},{name:b,extension:c}))};useEffect(function(){e&&P()},[e]),useEffect(function(){!e||F.name&&F.extension||P()},[B]),useEffect(function(){G(_objectSpread(_objectSpread({},F),{},{size:{width:f.width,height:f.height}}))},[f]),useEffect(function(){return isFieSaveMounted=!0,function(){isFieSaveMounted=!1}},[]);var Q=Array.isArray(y)&&0<y.length?y.map(function(a,b){return _objectSpread(_objectSpread({},a),{},{key:"".concat(a.label||b,"-option-key"),onClick:"function"==typeof a.onClick?function(){return a.onClick(function(a){return O(a,N)},function(a){return O(a,L)})}:void 0})}):[];return React.createElement(React.Fragment,null,React.createElement(ButtonWithMenu,{className:"FIE_topbar-save",color:"primary",label:j("save"),onClick:N,menuPosition:"bottom",menuItems:Q,menuStyle:saveButtonMenuStyle,wrapperStyle:saveButtonWrapperStyle,disabled:g||J}),B&&React.createElement(Modal,{className:"FIE_save-modal",title:j("saveAsModalLabel"),Icon:function Icon(a){return React.createElement(SaveAs,_extends({color:c.palette["accent-primary"]},a))},isOpened:B,onCancel:function cancelModal(){isFieSaveMounted&&B&&(b.current=null,C(!1))},onDone:M,doneLabel:j("save"),cancelLabel:j("cancel"),doneButtonColor:"primary",areButtonsDisabled:g,zIndex:11110},React.createElement(StyledFileNameInput,{className:"FIE_save-file-name-input",value:F.name,onChange:function changeFileName(a){var b=a.target.value;G(_objectSpread(_objectSpread({},F),{},{name:b}))},size:"sm",placeholder:j("name"),error:!F.name,focusOnMount:!0}),React.createElement(StyledFileExtensionSelect,{className:"FIE_save-extension-selector",onChange:function onChange(a){return G(_objectSpread(_objectSpread({},F),{},{extension:a}))},value:F.extension,placeholder:j("extension"),size:"sm"},SUPPORTED_IMAGE_TYPES.map(function(a){return React.createElement(MenuItem,{key:a,value:a},a)})),I&&React.createElement(StyledQualityWrapper,{className:"FIE_save-quality-wrapper"},React.createElement(Label,null,j("quality")),React.createElement(Slider,{annotation:"%",min:1,max:100,onChange:function changeQuality(a){G(_objectSpread(_objectSpread({},F),{},{quality:restrictNumber(a/100,.01,1)}))},value:parseInt(100*F.quality,10),width:"100%",style:sliderStyle})),React.createElement(StyledResizeOnSave,{className:"FIE_save-resize-wrapper"},React.createElement(Label,null,j("resize")),React.createElement(Resize,{onChange:function resizeImageFile(a){G(_objectSpread(_objectSpread({},F),{},{size:_objectSpread(_objectSpread({},F.size),a)}))},currentSize:(null===F||void 0===F?void 0:F.size)||{},hideResetButton:!0,alignLeft:!0}))))};export default SaveButton;